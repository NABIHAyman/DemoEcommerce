# Configuration principale de la sécurité de l'application
security:
    # --- MATRICE DES PERMISSIONS (RBAC) ---
    role_hierarchy:
        ROLE_ADMIN: ROLE_USER

    # 1. GESTION DU HACHAGE DES MOTS DE PASSE
    # Symfony ne stocke JAMAIS de mots de passe en clair.
    # L'option 'auto' demande à Symfony de choisir lui-même l'algorithme le plus sécurisé
    password_hashers:
        Symfony\Component\Security\Core\User\PasswordAuthenticatedUserInterface: 'auto'

    # 2. FOURNISSEUR D'UTILISATEURS (USER PROVIDERS)
    # Définit comment Symfony va chercher les données de l'utilisateur pour vérifier ses identifiants.
    providers:
        app_user_provider:
            # On utilise Doctrine pour interroger la base de données.
            entity:
                # La classe de l'entité qui représente nos utilisateurs.
                class: App\Entity\User
                # Le champ unique qui sert d'identifiant pour la connexion (le login).
                property: email

    # 3. LES PARE-FEUX (FIREWALLS)
    # C'est ici qu'on définit les zones de l'application qui sont protégées.
    firewalls:
        # Zone de développement : on désactive la sécurité pour les outils de debug
        # (profiler, barre de debug, images, assets JS/CSS) afin d'éviter d'être bloqué.
        dev:
            pattern: ^/(_(profiler|wdt)|css|images|js)/
            security: false

        # Pare-feu principal : il gère la majorité de l'application.
        main:
            # 'lazy: true' signifie que Symfony ne démarre la session que si l'application
            # a réellement besoin de vérifier si l'utilisateur est connecté (optimise les performances).
            lazy: true
            # On indique quel provider utiliser pour ce firewall.
            provider: app_user_provider

            # --- AUTHENTICATION PAR FORMULAIRE (TWIG) ---
            # Active le mécanisme d'authentification standard via un formulaire HTML.
            form_login:
                # La route qui affiche le formulaire de connexion.
                login_path: app_login
                # La route vers laquelle le formulaire est envoyé (gérée nativement par Symfony).
                check_path: app_login
                # Active la protection contre les failles CSRF (Cross-Site Request Forgery).
                enable_csrf: true
                # Redirection automatique vers cette route après une connexion réussie.
                default_target_path: app_products

            # --- GESTION DE LA DÉCONNEXION ---
            # Définit comment l'utilisateur peut quitter sa session.
            logout:
                # La route qui déclenche la déconnexion.
                path: app_logout
                # Où renvoyer l'utilisateur une fois qu'il est déconnecté.
                target: app_login

    # 4. CONTRÔLE D'ACCÈS (ACCESS CONTROL)
    # C'est ici qu'on définit les règles de filtrage par URL.
    # Attention : la première règle qui correspond est la seule appliquée.
    access_control:
        # PUBLIC_ACCESS : On permet à tout le monde d'accéder à la page de login,
        # sinon on aurait une boucle de redirection infinie.
        - { path: ^/login, roles: PUBLIC_ACCESS }
        - { path: ^/forgot-password, roles: PUBLIC_ACCESS }
        - { path: ^/register, roles: PUBLIC_ACCESS }

        # ROLE_USER : Toutes les URLs commençant par /products demandent au minimum
        # que l'utilisateur soit authentifié et possède le rôle de base.
        - { path: ^/products, roles: ROLE_USER }

# CONFIGURATION SPÉCIFIQUE POUR LES TESTS UNITAIRES ET FONCTIONNELS
# On réduit au maximum la puissance du hachage pour accélérer l'exécution des tests.
when@test:
    security:
        password_hashers:
            # On utilise des valeurs minimales (cost, time, memory) pour que les tests
            # ne prennent pas 10 secondes à chaque création d'utilisateur factice.
            Symfony\Component\Security\Core\User\PasswordAuthenticatedUserInterface:
                algorithm: auto
                cost: 4
                time_cost: 3
                memory_cost: 10
